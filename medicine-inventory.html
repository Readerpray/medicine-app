<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* æ¥µç°¡ç™»å…¥æ¨£å¼ */
        .login-container {
            max-width: 350px;
            margin: 100px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 50px 40px;
        }
        .login-container h1 { color: #667eea; text-align: center; margin-bottom: 30px; font-size: 3em; }
        .login-container input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 20px; transition: border-color 0.3s; }
        .login-container input:focus { outline: none; border-color: #667eea; }
        .login-container button { width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .login-container button:hover { background: #5568d3; transform: translateY(-2px); }

        /* ä¸»ç¨‹å¼æ¨£å¼ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        h1 { color: #667eea; text-align: center; margin-bottom: 10px; font-size: 2em; }

        .sync-status { text-align: center; padding: 10px; background: #d4edda; border-radius: 8px; margin-bottom: 20px; color: #155724; font-weight: bold; }
        .sync-status.syncing { background: #fff3cd; color: #856404; }
        .sync-status.offline { background: #f8d7da; color: #721c24; }

        .auth-panel, .add-item-panel { background: #e7f3ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .add-item-panel { background: #f8f9fa; margin-top: 30px; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #333; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, select:focus { outline: none; border-color: #667eea; }

        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s; font-weight: bold; }
        
        /* æŒ‰éˆ•é¡è‰² */
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; padding: 8px 16px; font-size: 14px; }
        .btn-warning { background: #ffc107; color: #333; padding: 8px 16px; font-size: 14px; }
        .btn-info { background: #17a2b8; color: white; padding: 8px 16px; font-size: 14px; }
        .btn-secondary { background: #6c757d; color: white; padding: 8px 16px; font-size: 14px; }
        .btn-archive { background: #6f42c1; color: white; padding: 8px 16px; font-size: 14px; } /* ç´«è‰²å°å­˜æŒ‰éˆ• */
        .btn-archive:hover { background: #5a32a3; }
        .btn-unarchive { background: #fd7e14; color: white; padding: 8px 16px; font-size: 14px; } /* æ©˜è‰²è§£å°å­˜ */

        .inventory-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .inventory-table th, .inventory-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .inventory-table thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .inventory-table tbody tr:hover { background: #f8f9fa; }
        
        /* å°å­˜æ¨£å¼ */
        .archived-row { background: #f0f0f0 !important; color: #888; }
        .archived-row strong { color: #666; }
        
        .drag-handle { cursor: move; color: #999; font-size: 18px; margin-right: 8px; }
        .stock-low { background: #fff3cd !important; }
        .stock-zero { background: #f8d7da !important; }
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }

        /* æœå°‹èˆ‡éæ¿¾å€ */
        .search-filter-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        .search-box { flex-grow: 1; margin-bottom: 0; }
        .filter-toggle {
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            color: #666;
        }

        /* æ¨¡æ…‹æ¡† */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        .close { float: right; font-size: 28px; cursor: pointer; color: #aaa; }
        
        .history-item { padding: 10px; border-left: 4px solid #667eea; margin-bottom: 10px; background: #f8f9fa; border-radius: 5px; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-card h3 { font-size: 2em; margin-bottom: 5px; }

        .collapsible-header { cursor: pointer; padding: 10px; background: #667eea; color: white; border-radius: 8px; margin-bottom: 10px; font-weight: bold; }
        .collapsible-content { display: none; }
        .collapsible-content.active { display: block; }
        
        .token-input { font-family: monospace; font-size: 14px; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .error { color: #dc3545; font-size: 14px; margin-top: 10px; text-align: center; }
        .hidden { display: none; }

        @media (max-width: 768px) {
            .search-filter-container { flex-direction: column; align-items: stretch; }
            .container { padding: 15px; }
            .inventory-table th, .inventory-table td { padding: 10px 5px; font-size: 14px; }
            button { padding: 10px 16px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <!-- æ¥µç°¡ç™»å…¥ç•«é¢ -->
    <div id="loginScreen" class="login-container">
        <h1>ğŸ”</h1>
        <input type="password" id="appPassword" placeholder="" autofocus>
        <button onclick="login()">Enter</button>
        <div id="loginError" class="error hidden"></div>
    </div>

    <!-- ä¸»ç¨‹å¼ç•«é¢ -->
    <div id="mainApp" class="container hidden">
        <h1>ğŸ’Š è—¥å“ä¿å¥å“åº«å­˜ç®¡ç†ç³»çµ±</h1>
        <div class="sync-status" id="syncStatus">
            <span class="status-indicator status-disconnected" id="statusIndicator"></span>
            <span id="statusText">ğŸ“¡ è«‹å…ˆé€£æ¥ GitHub</span>
        </div>

        <!-- GitHub è¨­å®š (é è¨­æ”¶åˆ) -->
        <div class="auth-panel">
            <div class="collapsible-header" onclick="toggleAuthPanel()">
                âš™ï¸ GitHub è¨­å®šï¼ˆé»æ“Šå±•é–‹/æ”¶åˆï¼‰
            </div>
            <div class="collapsible-content" id="authContent">
                <div class="form-group">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" class="token-input" placeholder="è²¼ä¸Šæ‚¨çš„ GitHub Token (ghp_...)">
                </div>
                <div class="form-group">
                    <label>GitHub ä½¿ç”¨è€…åç¨±</label>
                    <input type="text" id="githubUsername" placeholder="æ‚¨çš„ GitHub ä½¿ç”¨è€…åç¨±">
                </div>
                <div class="form-group">
                    <label>Repository åç¨±</label>
                    <input type="text" id="githubRepo" value="medicine-data" placeholder="medicine-data">
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="saveGitHubConfig()">ğŸ’¾ å„²å­˜ä¸¦é€£æ¥</button>
                    <button class="btn-info" onclick="testGitHubConnection()">ğŸ” æ¸¬è©¦é€£ç·š</button>
                    <button class="btn-danger" onclick="disconnectGitHub()" id="disconnectBtn" style="display:none;">ğŸ”“ ä¸­æ–·é€£æ¥</button>
                </div>
            </div>
        </div>

        <div class="stats" id="stats"></div>

        <!-- æœå°‹èˆ‡éæ¿¾ -->
        <div class="search-filter-container">
            <div class="search-box">
                <input type="text" id="searchBox" placeholder="ğŸ” æœå°‹å“é …åç¨±æˆ–åˆ†é¡..." onkeyup="filterItems()">
            </div>
            <label class="filter-toggle">
                <input type="checkbox" id="showArchived" onchange="filterItems()">
                é¡¯ç¤ºå·²å°å­˜é …ç›®
            </label>
        </div>

        <div class="button-group" style="margin-bottom: 20px;">
            <button class="btn-success" onclick="manualSync()">â˜ï¸ æ‰‹å‹•åŒæ­¥</button>
            <button class="btn-warning" onclick="loadFromGitHub()">ğŸ“¥ é‡æ–°è¼‰å…¥</button>
            <button class="btn-info" onclick="exportBackup()">ğŸ’¾ ä¸‹è¼‰å‚™ä»½</button>
        </div>

        <div style="overflow-x: auto;">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>å“é …åç¨±</th>
                        <th>åˆ†é¡</th>
                        <th>æ•¸é‡</th>
                        <th>æ•ˆæœŸ</th>
                        <th>æœ€å¾Œä½¿ç”¨</th>
                        <th>å‚™è¨»</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
            </table>
        </div>

        <!-- æ–°å¢å“é … (ç§»åˆ°åº•éƒ¨ï¼Œé è¨­æ”¶åˆ) -->
        <div class="add-item-panel">
            <div class="collapsible-header" onclick="toggleAddItemPanel()">
                â• æ–°å¢å“é …ï¼ˆé»æ“Šå±•é–‹/æ”¶åˆï¼‰
            </div>
            <div class="collapsible-content" id="addItemContent">
                <div class="control-panel">
                    <div class="form-group">
                        <label>å“é …åç¨±</label>
                        <input type="text" id="itemName" placeholder="ä¾‹å¦‚ï¼šç¶­ä»–å‘½Cã€æ„Ÿå†’è—¥">
                    </div>
                    <div class="form-group">
                        <label>åˆ†é¡</label>
                        <select id="itemCategory">
                            <option value="è—¥å“">è—¥å“</option>
                            <option value="ä¿å¥å“">ä¿å¥å“</option>
                            <option value="å¤–ç”¨è—¥">å¤–ç”¨è—¥</option>
                            <option value="é†«ç™‚ç”¨å“">é†«ç™‚ç”¨å“</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åˆå§‹æ•¸é‡</label>
                        <input type="number" id="itemQuantity" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>æ•ˆæœŸï¼ˆé¸å¡«ï¼‰</label>
                        <input type="date" id="itemExpiry">
                    </div>
                    <div class="form-group">
                        <label>ä½åº«å­˜è­¦ç¤ºï¼ˆé¸å¡«ï¼‰</label>
                        <input type="number" id="itemMinStock" min="0" placeholder="ä½æ–¼æ­¤æ•¸é‡æ™‚æé†’">
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                        <input type="text" id="itemNote" placeholder="ç”¨é€”ã€æœç”¨æ–¹å¼ç­‰">
                    </div>
                    <button class="btn-primary" onclick="addItem()">â• æ–°å¢å“é …</button>
                </div>
            </div>
        </div>

    </div>

    <!-- æ¨¡æ…‹æ¡†ï¼šæ•¸é‡å¢æ¸› -->
    <div id="quantityModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" style="color: #667eea; margin-bottom: 20px;"></h2>
            <div class="form-group">
                <label>æ•¸é‡</label>
                <input type="number" id="modalQuantity" min="1" value="1">
            </div>
            <div class="form-group">
                <label>æ“ä½œå‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                <input type="text" id="modalNote" placeholder="ä¾‹å¦‚ï¼šæ„Ÿå†’ç—‡ç‹€ã€å®šæœŸè£œå……">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="confirmQuantityChange()">ç¢ºèª</button>
                <button class="btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†ï¼šç·¨è¼¯ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">âœï¸ ç·¨è¼¯å“é …</h2>
            <div class="form-group">
                <label>å“é …åç¨±</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>åˆ†é¡</label>
                <select id="editCategory">
                    <option value="è—¥å“">è—¥å“</option>
                    <option value="ä¿å¥å“">ä¿å¥å“</option>
                    <option value="å¤–ç”¨è—¥">å¤–ç”¨è—¥</option>
                    <option value="é†«ç™‚ç”¨å“">é†«ç™‚ç”¨å“</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ•¸é‡</label>
                <input type="number" id="editQuantity" min="0">
            </div>
            <div class="form-group">
                <label>æ•ˆæœŸ</label>
                <input type="date" id="editExpiry">
            </div>
            <div class="form-group">
                <label>ä½åº«å­˜è­¦ç¤º</label>
                <input type="number" id="editMinStock" min="0">
            </div>
            <div class="form-group">
                <label>å‚™è¨»</label>
                <input type="text" id="editNote">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="confirmEdit()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                <button class="btn-danger" onclick="closeEditModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†ï¼šæ­·å²ç´€éŒ„ -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHistoryModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“‹ è®Šå‹•æ­·å²</h2>
            <div id="historyContent"></div>
        </div>
    </div>

    <!-- CryptoJS åŠ å¯†åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <script>
        // ============ å®‰å…¨é…ç½® ============
        // è«‹ç”¨ https://emn178.github.io/online-tools/sha256.html ç”¢ç”Ÿå¯†ç¢¼é›œæ¹Š
        const APP_PASSWORD_HASH = '29624e2e4c4ccee26ed8f3e0ca1012ea57a8f2191be6149f632250f7036119cc';

        let isLoggedIn = false;
        let appPassword = '';
        let inventory = [];
        let currentEditItem = null;
        let currentAction = '';
        let githubToken = '';
        let githubUsername = '';
        let githubRepo = '';
        let githubFileSha = '';
        const GITHUB_FILE_PATH = 'medicine-inventory.json';
        let draggedElement = null;
        let draggedIndex = null;

        // ============ ç™»å…¥ ============
        function login() {
            const password = document.getElementById('appPassword').value;
            const hash = CryptoJS.SHA256(password).toString();
            
            if (hash === APP_PASSWORD_HASH) {
                isLoggedIn = true;
                appPassword = password;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadSettings();
                init();
            } else {
                const err = document.getElementById('loginError');
                err.textContent = 'Invalid';
                err.classList.remove('hidden');
                setTimeout(() => err.classList.add('hidden'), 2000);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('appPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });

        // ============ åŠ å¯†/è§£å¯† ============
        function encryptData(data) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), appPassword).toString();
        }

        function decryptData(encryptedData) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, appPassword);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch (error) {
                console.error('è§£å¯†å¤±æ•—:', error);
                return null;
            }
        }

        // ============ åˆå§‹åŒ– ============
        function init() {
            if (githubToken && githubUsername) {
                updateSyncStatus('connected', 'âœ… å·²é€£æ¥ GitHub');
                loadFromGitHub();
            } else {
                updateSyncStatus('offline', 'âš ï¸ è«‹è¨­å®š GitHub');
            }
            const backup = localStorage.getItem('inventoryBackup');
            if (backup && !githubToken) {
                inventory = JSON.parse(backup);
                renderInventory();
                updateStats();
            }
        }

        function loadSettings() {
            githubToken = localStorage.getItem('githubToken_secure') || '';
            githubUsername = localStorage.getItem('githubUsername_secure') || '';
            githubRepo = localStorage.getItem('githubRepo_secure') || 'medicine-data';
            
            if (githubToken) {
                document.getElementById('githubToken').value = githubToken;
                document.getElementById('githubUsername').value = githubUsername;
                document.getElementById('githubRepo').value = githubRepo;
                document.getElementById('disconnectBtn').style.display = 'inline-block';
            }
        }

        // ============ é¢æ¿æ§åˆ¶ ============
        function toggleAuthPanel() {
            document.getElementById('authContent').classList.toggle('active');
        }

        function toggleAddItemPanel() {
            document.getElementById('addItemContent').classList.toggle('active');
        }

        // ============ GitHub æ“ä½œ ============
        function saveGitHubConfig() {
            const token = document.getElementById('githubToken').value.trim();
            const username = document.getElementById('githubUsername').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            
            if (!token || !username || !repo) { alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼'); return; }
            
            githubToken = token; githubUsername = username; githubRepo = repo;
            
            localStorage.setItem('githubToken_secure', token);
            localStorage.setItem('githubUsername_secure', username);
            localStorage.setItem('githubRepo_secure', repo);
            
            document.getElementById('disconnectBtn').style.display = 'inline-block';
            alert('è¨­å®šå·²å„²å­˜ï¼å³å°‡æ¸¬è©¦é€£ç·š...');
            testGitHubConnection();
        }

        async function testGitHubConnection() {
            if (!githubToken) return;
            updateSyncStatus('syncing', 'ğŸ” æ¸¬è©¦é€£ç·šä¸­...');
            try {
                const response = await fetch(`https://api.github.com/repos/${githubUsername}/${githubRepo}`, {
                    headers: { 'Authorization': `token ${githubToken}` }
                });
                if (response.ok) {
                    updateSyncStatus('connected', 'âœ… é€£ç·šæˆåŠŸï¼');
                    alert('âœ… é€£ç·šæˆåŠŸï¼');
                    loadFromGitHub();
                } else { throw new Error(response.status); }
            } catch (error) {
                updateSyncStatus('offline', 'âŒ é€£ç·šå¤±æ•—');
                alert('âŒ é€£ç·šå¤±æ•—');
            }
        }

        function disconnectGitHub() {
            if (confirm('ç¢ºå®šè¦ä¸­æ–·é€£æ¥å—ï¼Ÿ')) {
                githubToken = ''; githubUsername = ''; githubRepo = '';
                localStorage.removeItem('githubToken_secure');
                localStorage.removeItem('githubUsername_secure');
                localStorage.removeItem('githubRepo_secure');
                document.getElementById('disconnectBtn').style.display = 'none';
                updateSyncStatus('offline', 'âŒ å·²ä¸­æ–·');
            }
        }

        async function loadFromGitHub() {
            if (!githubToken) return;
            updateSyncStatus('syncing', 'â˜ï¸ è¼‰å…¥ä¸­...');
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${GITHUB_FILE_PATH}`,
                    { headers: { 'Authorization': `token ${githubToken}` } }
                );

                if (response.ok) {
                    const data = await response.json();
                    githubFileSha = data.sha;
                    const content = atob(data.content);
                    const decrypted = decryptData(content);
                    if (decrypted) {
                        inventory = decrypted;
                        saveData(false); // åªå­˜æœ¬åœ°ï¼Œä¸é‡è¤‡ä¸Šå‚³
                        renderInventory();
                        updateStats();
                        updateSyncStatus('connected', 'âœ… å·²è¼‰å…¥');
                    }
                } else if (response.status === 404) {
                    await saveToGitHub();
                }
            } catch (error) {
                updateSyncStatus('offline', 'âŒ è¼‰å…¥å¤±æ•—');
            }
        }

        async function saveToGitHub() {
            if (!githubToken) return false;
            updateSyncStatus('syncing', 'â˜ï¸ åŒæ­¥ä¸­...');
            try {
                const encrypted = encryptData(inventory);
                const content = btoa(unescape(encodeURIComponent(encrypted)));
                const body = {
                    message: `Update ${new Date().toLocaleString()}`,
                    content: content,
                    sha: githubFileSha || undefined
                };

                const response = await fetch(
                    `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${GITHUB_FILE_PATH}`,
                    {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${githubToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    githubFileSha = data.content.sha;
                    updateSyncStatus('connected', 'âœ… å·²åŒæ­¥');
                    return true;
                }
            } catch (error) {
                updateSyncStatus('offline', 'âŒ åŒæ­¥å¤±æ•—');
            }
            return false;
        }

        async function manualSync() {
            if (await saveToGitHub()) alert('âœ… åŒæ­¥å®Œæˆ');
        }

        function updateSyncStatus(status, msg) {
            const el = document.getElementById('syncStatus');
            const ind = document.getElementById('statusIndicator');
            document.getElementById('statusText').textContent = msg;
            
            if (status === 'connected') {
                el.className = 'sync-status'; ind.className = 'status-indicator status-connected';
            } else if (status === 'syncing') {
                el.className = 'sync-status syncing'; ind.className = 'status-indicator status-connected';
            } else {
                el.className = 'sync-status offline'; ind.className = 'status-indicator status-disconnected';
            }
        }

        function saveData(sync = true) {
            localStorage.setItem('inventoryBackup', JSON.stringify(inventory));
            if (sync && githubToken) saveToGitHub();
        }

        // ============ å“é …æ“ä½œ ============
        function addItem() {
            const name = document.getElementById('itemName').value.trim();
            if (!name) { alert('è«‹è¼¸å…¥åç¨±'); return; }

            const item = {
                id: Date.now(),
                name: name,
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                expiry: document.getElementById('itemExpiry').value,
                minStock: parseInt(document.getElementById('itemMinStock').value) || 0,
                note: document.getElementById('itemNote').value.trim(),
                isArchived: false, // é è¨­æœªå°å­˜
                history: [{ date: new Date().toISOString(), action: 'æ–°å¢', quantity: 0, note: 'åˆå§‹å»ºç«‹' }]
            };

            inventory.push(item);
            saveData();
            renderInventory();
            updateStats();
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('itemName').value = '';
            document.getElementById('itemQuantity').value = '0';
            document.getElementById('itemExpiry').value = '';
            document.getElementById('itemMinStock').value = '';
            document.getElementById('itemNote').value = '';
            alert('âœ… æ–°å¢æˆåŠŸ');
        }

        // ============ åˆ—è¡¨æ¸²æŸ“ (å«å°å­˜é‚è¼¯) ============
        function renderInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';

            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const showArchived = document.getElementById('showArchived').checked;

            const filtered = inventory.filter(item => {
                const matchSearch = item.name.toLowerCase().includes(searchTerm) || 
                                  item.category.toLowerCase().includes(searchTerm);
                
                if (showArchived) return matchSearch; // é¡¯ç¤ºå…¨éƒ¨
                return matchSearch && !item.isArchived; // åªé¡¯ç¤ºæœªå°å­˜
            });

            filtered.forEach((item, index) => {
                const row = document.createElement('tr');
                if (item.isArchived) row.classList.add('archived-row');
                
                // æ‹–æ›³åŠŸèƒ½
                row.draggable = true;
                row.dataset.id = item.id;
                row.dataset.index = inventory.indexOf(item); // ç”¨åŸå§‹ index
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);

                // ç‹€æ…‹æ¨£å¼
                if (!item.isArchived) {
                    if (item.quantity === 0) row.classList.add('stock-zero');
                    else if (item.minStock > 0 && item.quantity <= item.minStock) row.classList.add('stock-low');
                }

                // æ•ˆæœŸé¡¯ç¤º
                let expiryDisplay = item.expiry || '-';
                if (item.expiry && !item.isArchived) {
                    const days = Math.floor((new Date(item.expiry) - new Date()) / 86400000);
                    if (days < 0) expiryDisplay += ' âš ï¸å·²éæœŸ';
                    else if (days <= 30) expiryDisplay += ` âš ï¸${days}å¤©`;
                }

                // æœ€å¾Œä½¿ç”¨æ™‚é–“
                let lastUsedStr = '-';
                if (item.history) {
                    const lastUse = item.history
                        .filter(h => ['ä½¿ç”¨','æ¸›å°‘'].includes(h.action))
                        .sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                    if (lastUse) lastUsedStr = new Date(lastUse.date).toLocaleDateString();
                }

                // å°å­˜æŒ‰éˆ•æ–‡å­—
                const archiveBtn = item.isArchived 
                    ? `<button class="btn-unarchive" onclick="toggleArchive(${item.id})">ğŸ”“ è§£å°</button>`
                    : `<button class="btn-archive" onclick="toggleArchive(${item.id})">ğŸ“¦ å°å­˜</button>`;

                row.innerHTML = `
                    <td><span class="drag-handle">â‹®â‹®</span></td>
                    <td><strong>${item.name}</strong>${item.isArchived ? ' (å·²å°å­˜)' : ''}</td>
                    <td><span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${item.category}</span></td>
                    <td><strong>${item.quantity}</strong></td>
                    <td>${expiryDisplay}</td>
                    <td>${lastUsedStr}</td>
                    <td>${item.note || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            ${!item.isArchived ? `
                                <button class="btn-secondary" onclick="openEditModal(${item.id})">âœï¸</button>
                                <button class="btn-success" onclick="openQuantityModal(${item.id}, 'add')">â•</button>
                                <button class="btn-warning" onclick="openQuantityModal(${item.id}, 'reduce')">â–</button>
                            ` : ''}
                            <button class="btn-info" onclick="showHistory(${item.id})">ğŸ“‹</button>
                            ${archiveBtn}
                            <button class="btn-danger" onclick="deleteItem(${item.id})">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">ç„¡è³‡æ–™</td></tr>';
            }
        }

        // ============ æ‹–æ›³åŠŸèƒ½ ============
        function handleDragStart(e) { draggedElement = this; draggedIndex = parseInt(this.dataset.index); this.classList.add('dragging'); }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
        function handleDrop(e) {
            e.stopPropagation();
            const dropIndex = parseInt(this.dataset.index);
            if (draggedIndex !== dropIndex && draggedIndex !== null) {
                const item = inventory[draggedIndex];
                inventory.splice(draggedIndex, 1);
                inventory.splice(dropIndex, 0, item);
                saveData();
                renderInventory();
            }
        }
        function handleDragEnd() { this.classList.remove('dragging'); draggedElement = null; draggedIndex = null; }

        // ============ å½ˆå‡ºè¦–çª—æ“ä½œ ============
        function openQuantityModal(id, action) {
            currentEditItem = inventory.find(i => i.id === id);
            currentAction = action;
            document.getElementById('modalTitle').textContent = action === 'add' ? `â• å¢åŠ : ${currentEditItem.name}` : `â– æ¸›å°‘: ${currentEditItem.name}`;
            document.getElementById('modalQuantity').value = '1';
            document.getElementById('modalNote').value = ''; // æ¸…ç©ºå‚™è¨»
            document.getElementById('quantityModal').style.display = 'block';
        }

        function confirmQuantityChange() {
            const qty = parseInt(document.getElementById('modalQuantity').value);
            const note = document.getElementById('modalNote').value.trim();
            if (qty <= 0) return;

            if (currentAction === 'add') {
                currentEditItem.quantity += qty;
                currentEditItem.history.push({
                    date: new Date().toISOString(),
                    action: 'è³¼è²·',
                    quantity: qty,
                    note: note ? `å¢åŠ  ${qty} (${note})` : `å¢åŠ  ${qty}`
                });
            } else {
                if (currentEditItem.quantity < qty) { alert('åº«å­˜ä¸è¶³'); return; }
                currentEditItem.quantity -= qty;
                currentEditItem.history.push({
                    date: new Date().toISOString(),
                    action: 'ä½¿ç”¨',
                    quantity: qty,
                    note: note ? `æ¸›å°‘ ${qty} (${note})` : `æ¸›å°‘ ${qty}`
                });
            }
            saveData();
            renderInventory();
            updateStats();
            closeModal();
        }

        function toggleArchive(id) {
            const item = inventory.find(i => i.id === id);
            item.isArchived = !item.isArchived;
            item.history.push({
                date: new Date().toISOString(),
                action: item.isArchived ? 'å°å­˜' : 'è§£å°',
                note: item.isArchived ? 'å·²å°å­˜å“é …' : 'è§£é™¤å°å­˜'
            });
            saveData();
            renderInventory();
            updateStats(); // å°å­˜ä¸è¨ˆå…¥çµ±è¨ˆ
        }

        function openEditModal(id) {
            currentEditItem = inventory.find(i => i.id === id);
            document.getElementById('editName').value = currentEditItem.name;
            document.getElementById('editCategory').value = currentEditItem.category;
            document.getElementById('editQuantity').value = currentEditItem.quantity;
            document.getElementById('editExpiry').value = currentEditItem.expiry || '';
            document.getElementById('editMinStock').value = currentEditItem.minStock || 0;
            document.getElementById('editNote').value = currentEditItem.note || '';
            document.getElementById('editModal').style.display = 'block';
        }

        function confirmEdit() {
            const name = document.getElementById('editName').value;
            // ... (çœç•¥éƒ¨åˆ†æ¬„ä½æª¢æŸ¥ï¼Œé‚è¼¯åŒå‰)
            
            // è¨˜éŒ„è®Šæ›´
            currentEditItem.name = name;
            currentEditItem.category = document.getElementById('editCategory').value;
            currentEditItem.quantity = parseInt(document.getElementById('editQuantity').value);
            currentEditItem.expiry = document.getElementById('editExpiry').value;
            currentEditItem.minStock = parseInt(document.getElementById('editMinStock').value);
            currentEditItem.note = document.getElementById('editNote').value;
            
            currentEditItem.history.push({ date: new Date().toISOString(), action: 'ç·¨è¼¯', note: 'è³‡æ–™æ›´æ–°' });
            
            saveData();
            renderInventory();
            closeEditModal();
        }

        function showHistory(id) {
            const item = inventory.find(i => i.id === id);
            const content = document.getElementById('historyContent');
            content.innerHTML = `<h3>${item.name} æ­·å²ç´€éŒ„</h3>`;
            item.history.slice().reverse().forEach(h => {
                content.innerHTML += `
                    <div class="history-item">
                        <strong>${h.action}</strong> - ${new Date(h.date).toLocaleString()}<br>
                        ${h.note || ''}
                    </div>
                `;
            });
            document.getElementById('historyModal').style.display = 'block';
        }

        function deleteItem(id) {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿç„¡æ³•å¾©åŸï¼')) {
                inventory = inventory.filter(i => i.id !== id);
                saveData();
                renderInventory();
                updateStats();
            }
        }

        function updateStats() {
            // æ’é™¤å·²å°å­˜é …ç›®
            const activeItems = inventory.filter(i => !i.isArchived);
            const total = activeItems.length;
            const low = activeItems.filter(i => i.minStock > 0 && i.quantity <= i.minStock).length;
            const expired = activeItems.filter(i => i.expiry && new Date(i.expiry) < new Date()).length;

            document.getElementById('stats').innerHTML = `
                <div class="stat-card"><h3>${total}</h3><p>ä½¿ç”¨ä¸­å“é …</p></div>
                <div class="stat-card"><h3>${low}</h3><p>ä½åº«å­˜</p></div>
                <div class="stat-card"><h3>${expired}</h3><p>å·²éæœŸ</p></div>
            `;
        }

        function exportBackup() {
            const blob = new Blob([JSON.stringify(inventory, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function filterItems() { renderInventory(); }
        
        function closeModal() { document.getElementById('quantityModal').style.display = 'none'; }
        function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }
        function closeHistoryModal() { document.getElementById('historyModal').style.display = 'none'; }
        
        window.onclick = function(e) {
            if (e.target.classList.contains('modal')) e.target.style.display = 'none';
        }
    </script>
</body>
</html>
