<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* æ¥µç°¡ç™»å…¥ */
        .login-container {
            max-width: 350px;
            margin: 100px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 50px 40px;
        }
        .login-container h1 { color: #667eea; text-align: center; margin-bottom: 30px; font-size: 3em; }
        .login-container input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 20px; }
        .login-container button { width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; }

        /* ä¸»ç¨‹å¼ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        h1 { color: #667eea; text-align: center; margin-bottom: 10px; font-size: 2em; }

        /* é¢æ¿èˆ‡è¡¨å–® */
        .auth-panel, .add-item-panel { background: #e7f3ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .add-item-panel { background: #f8f9fa; margin-top: 30px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #333; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        
        /* éš±è—æ•¸é‡è¼¸å…¥æ¡† (ç•¶é¸æ“‡ç´€éŒ„å‹æ™‚) */
        .hidden-input { display: none; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #333; padding: 8px 12px; font-size: 14px; }
        .btn-danger { background: #dc3545; color: white; padding: 8px 12px; font-size: 14px; }
        .btn-info { background: #17a2b8; color: white; padding: 8px 12px; font-size: 14px; }
        .btn-secondary { background: #6c757d; color: white; padding: 8px 12px; font-size: 14px; }
        .btn-archive { background: #6f42c1; color: white; padding: 8px 12px; font-size: 14px; }
        .btn-unarchive { background: #fd7e14; color: white; padding: 8px 12px; font-size: 14px; }
        .btn-log { background: #007bff; color: white; padding: 8px 12px; font-size: 14px; } /* è—è‰²ç´€éŒ„æŒ‰éˆ• */
        .btn-finish { background: #343a40; color: white; padding: 8px 12px; font-size: 14px; } /* æ·±è‰²ç”¨å®ŒæŒ‰éˆ• */

        /* è¡¨æ ¼èˆ‡åˆ—è¡¨ */
        .inventory-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; } /* å›ºå®šå¯¬åº¦é˜²è·‘ç‰ˆ */
        .inventory-table th, .inventory-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        .inventory-table thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .inventory-table tbody tr:hover { background: #f8f9fa; }
        .archived-row { background: #f0f0f0 !important; color: #999; }
        
        .stock-low { background: #fff3cd !important; }
        .stock-zero { background: #f8d7da !important; }
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .drag-handle { cursor: move; color: #999; margin-right: 8px; }

        /* åˆ†é¡åœ–ç¤º */
        .category-icon { font-size: 20px; cursor: help; text-align: center; display: block; }
        
        /* ç‹€æ…‹æ¨™ç±¤ (ç´€éŒ„å‹ç”¨) */
        .status-badge { background: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; display: inline-block; }
        .status-empty { background: #6c757d; }

        /* æœå°‹èˆ‡çµ±è¨ˆ */
        .search-filter-container { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; }
        .search-box { flex-grow: 1; margin-bottom: 0; }
        .filter-toggle { display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight: bold; color: #555; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }

        /* é€šç”¨å…ƒä»¶ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        .close { float: right; font-size: 28px; cursor: pointer; color: #aaa; }
        .collapsible-header { cursor: pointer; padding: 10px; background: #667eea; color: white; border-radius: 8px; margin-bottom: 10px; font-weight: bold; }
        .collapsible-content { display: none; }
        .collapsible-content.active { display: block; }
        
        .sync-status { text-align: center; padding: 10px; background: #d4edda; border-radius: 8px; margin-bottom: 20px; color: #155724; font-weight: bold; }
        .sync-status.syncing { background: #fff3cd; color: #856404; }
        .sync-status.offline { background: #f8d7da; color: #721c24; }
        
        .token-input { font-family: monospace; font-size: 14px; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .error { color: #dc3545; font-size: 14px; margin-top: 10px; text-align: center; }
        .hidden { display: none; }

        @media (max-width: 768px) {
            .search-filter-container { flex-direction: column; align-items: stretch; }
            .container { padding: 15px; }
            .inventory-table th, .inventory-table td { padding: 10px 5px; font-size: 14px; }
            /* æ‰‹æ©Ÿç‰ˆèª¿æ•´åœ–ç¤ºå¤§å° */
            .category-icon { font-size: 24px; }
        }
    </style>
</head>
<body>
    <!-- æ¥µç°¡ç™»å…¥ç•«é¢ -->
    <div id="loginScreen" class="login-container">
        <h1>ğŸ”</h1>
        <input type="password" id="appPassword" placeholder="" autofocus>
        <button onclick="login()">Enter</button>
        <div id="loginError" class="error hidden"></div>
    </div>

    <!-- ä¸»ç¨‹å¼ç•«é¢ -->
    <div id="mainApp" class="container hidden">
        <h1>ğŸ’Š è—¥å“ä¿å¥å“åº«å­˜ç®¡ç†ç³»çµ±</h1>
        <div class="sync-status" id="syncStatus">
            <span class="status-indicator status-disconnected" id="statusIndicator"></span>
            <span id="statusText">ğŸ“¡ è«‹å…ˆé€£æ¥ GitHub</span>
        </div>

        <!-- GitHub è¨­å®š (é è¨­æ”¶åˆ) -->
        <div class="auth-panel">
            <div class="collapsible-header" onclick="toggleAuthPanel()">
                âš™ï¸ GitHub è¨­å®šï¼ˆé»æ“Šå±•é–‹/æ”¶åˆï¼‰
            </div>
            <div class="collapsible-content" id="authContent">
                <div class="form-group">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" class="token-input" placeholder="è²¼ä¸Šæ‚¨çš„ GitHub Token (ghp_...)">
                </div>
                <div class="form-group">
                    <label>GitHub ä½¿ç”¨è€…åç¨±</label>
                    <input type="text" id="githubUsername" placeholder="æ‚¨çš„ GitHub ä½¿ç”¨è€…åç¨±">
                </div>
                <div class="form-group">
                    <label>Repository åç¨±</label>
                    <input type="text" id="githubRepo" value="medicine-data" placeholder="medicine-data">
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="saveGitHubConfig()">ğŸ’¾ å„²å­˜ä¸¦é€£æ¥</button>
                    <button class="btn-info" onclick="testGitHubConnection()">ğŸ” æ¸¬è©¦é€£ç·š</button>
                    <button class="btn-danger" onclick="disconnectGitHub()" id="disconnectBtn" style="display:none;">ğŸ”“ ä¸­æ–·é€£æ¥</button>
                </div>
            </div>
        </div>

        <div class="stats" id="stats"></div>

        <!-- æœå°‹èˆ‡éæ¿¾ -->
        <div class="search-filter-container">
            <div class="search-box">
                <input type="text" id="searchBox" placeholder="ğŸ” æœå°‹å“é …åç¨±æˆ–åˆ†é¡..." onkeyup="filterItems()">
            </div>
            <label class="filter-toggle">
                <input type="checkbox" id="showArchived" onchange="filterItems()">
                é¡¯ç¤ºå·²å°å­˜é …ç›®
            </label>
        </div>

        <div class="button-group" style="margin-bottom: 20px;">
            <button class="btn-success" onclick="manualSync()">â˜ï¸ æ‰‹å‹•åŒæ­¥</button>
            <button class="btn-warning" onclick="loadFromGitHub()">ğŸ“¥ é‡æ–°è¼‰å…¥</button>
            <button class="btn-info" onclick="exportBackup()">ğŸ’¾ ä¸‹è¼‰å‚™ä»½</button>
        </div>

        <div style="overflow-x: auto;">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th style="width: 50px; text-align: center;">é¡</th> <!-- ç¸®çŸ­æ¨™é¡Œ -->
                        <th>å“é …åç¨±</th>
                        <th>ç‹€æ…‹/æ•¸é‡</th> <!-- åˆä½µæ¨™é¡Œ -->
                        <th style="width: 100px;">æ•ˆæœŸ</th>
                        <th style="width: 140px;">æœ€å¾Œä½¿ç”¨</th> <!-- åŠ å¯¬ä»¥é¡¯ç¤ºæ™‚é–“ -->
                        <th>å‚™è¨»</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
            </table>
        </div>

        <!-- æ–°å¢å“é … (ç§»åˆ°åº•éƒ¨ï¼Œé è¨­æ”¶åˆ) -->
        <div class="add-item-panel">
            <div class="collapsible-header" onclick="toggleAddItemPanel()">
                â• æ–°å¢å“é …ï¼ˆé»æ“Šå±•é–‹/æ”¶åˆï¼‰
            </div>
            <div class="collapsible-content" id="addItemContent">
                <div class="control-panel">
                    <div class="form-group">
                        <label>å“é …é¡å‹</label>
                        <select id="itemType" onchange="toggleQuantityInput()">
                            <option value="countable">ğŸ”¢ è¨ˆæ•¸å‹ (è—¥ä¸¸ã€è† å›Š)</option>
                            <option value="log_only">â±ï¸ ç´€éŒ„å‹ (è—¥æ°´ã€è—¥è†ã€å™´åŠ‘)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å“é …åç¨±</label>
                        <input type="text" id="itemName" placeholder="ä¾‹å¦‚ï¼šç¶­ä»–å‘½Cã€æ„Ÿå†’è—¥æ°´">
                    </div>
                    <div class="form-group">
                        <label>åˆ†é¡</label>
                        <select id="itemCategory">
                            <option value="è—¥å“">ğŸ’Š è—¥å“</option>
                            <option value="ä¿å¥å“">ğŸ¥— ä¿å¥å“</option>
                            <option value="å¤–ç”¨è—¥">ğŸ§´ å¤–ç”¨è—¥</option>
                            <option value="é†«ç™‚ç”¨å“">ğŸ©¹ é†«ç™‚ç”¨å“</option>
                            <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group" id="quantityGroup">
                        <label>åˆå§‹æ•¸é‡</label>
                        <input type="number" id="itemQuantity" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>æ•ˆæœŸï¼ˆé¸å¡«ï¼‰</label>
                        <input type="date" id="itemExpiry">
                    </div>
                    <div class="form-group" id="minStockGroup">
                        <label>ä½åº«å­˜è­¦ç¤ºï¼ˆé¸å¡«ï¼‰</label>
                        <input type="number" id="itemMinStock" min="0" placeholder="ä½æ–¼æ­¤æ•¸é‡æ™‚æé†’">
                    </div>
                    <div class="form-group">
                        <label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                        <input type="text" id="itemNote" placeholder="ç”¨é€”ã€æœç”¨æ–¹å¼ç­‰">
                    </div>
                    <button class="btn-primary" onclick="addItem()">â• æ–°å¢å“é …</button>
                </div>
            </div>
        </div>

    </div>

    <!-- æ¨¡æ…‹æ¡†ï¼šæ•¸é‡å¢æ¸› -->
    <div id="quantityModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle" style="color: #667eea; margin-bottom: 20px;"></h2>
            <div class="form-group">
                <label>æ•¸é‡</label>
                <input type="number" id="modalQuantity" min="1" value="1">
            </div>
            <div class="form-group">
                <label>æ“ä½œå‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                <input type="text" id="modalNote" placeholder="ä¾‹å¦‚ï¼šæ„Ÿå†’ç—‡ç‹€ã€å®šæœŸè£œå……">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="confirmQuantityChange()">ç¢ºèª</button>
                <button class="btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†ï¼šç´€éŒ„å‹ä½¿ç”¨ -->
    <div id="logModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLogModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">â±ï¸ ç´€éŒ„ä½¿ç”¨</h2>
            <p id="logItemName" style="margin-bottom: 15px; font-weight: bold;"></p>
            <div class="form-group">
                <label>æ“ä½œå‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                <input type="text" id="logNote" placeholder="ä¾‹å¦‚ï¼šæ“¦å‚·å£ã€ç¡å‰å™´">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="confirmLogUse()">âœ… ç¢ºèªç´€éŒ„</button>
                <button class="btn-danger" onclick="closeLogModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†ï¼šç·¨è¼¯ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">âœï¸ ç·¨è¼¯å“é …</h2>
            <div class="form-group">
                <label>å“é …é¡å‹</label>
                <select id="editType" onchange="toggleEditQuantityInput()">
                    <option value="countable">ğŸ”¢ è¨ˆæ•¸å‹</option>
                    <option value="log_only">â±ï¸ ç´€éŒ„å‹</option>
                </select>
                <p style="font-size: 12px; color: #666; margin-top: 5px;">âš ï¸ åˆ‡æ›é¡å‹å¯èƒ½æœƒå½±éŸ¿é¡¯ç¤ºæ–¹å¼</p>
            </div>
            <div class="form-group">
                <label>å“é …åç¨±</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>åˆ†é¡</label>
                <select id="editCategory">
                    <option value="è—¥å“">ğŸ’Š è—¥å“</option>
                    <option value="ä¿å¥å“">ğŸ¥— ä¿å¥å“</option>
                    <option value="å¤–ç”¨è—¥">ğŸ§´ å¤–ç”¨è—¥</option>
                    <option value="é†«ç™‚ç”¨å“">ğŸ©¹ é†«ç™‚ç”¨å“</option>
                    <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                </select>
            </div>
            <div class="form-group" id="editQuantityGroup">
                <label>æ•¸é‡</label>
                <input type="number" id="editQuantity" min="0">
            </div>
            <div class="form-group">
                <label>æ•ˆæœŸ</label>
                <input type="date" id="editExpiry">
            </div>
            <div class="form-group" id="editMinStockGroup">
                <label>ä½åº«å­˜è­¦ç¤º</label>
                <input type="number" id="editMinStock" min="0">
            </div>
            <div class="form-group">
                <label>å‚™è¨»</label>
                <input type="text" id="editNote">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="confirmEdit()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                <button class="btn-danger" onclick="closeEditModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡†ï¼šæ­·å²ç´€éŒ„ -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHistoryModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“‹ è®Šå‹•æ­·å²</h2>
            <div id="historyContent"></div>
        </div>
    </div>

    <!-- CryptoJS åŠ å¯†åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <script>
        // ============ å®‰å…¨é…ç½® ============
        const APP_PASSWORD_HASH = '29624e2e4c4ccee26ed8f3e0ca1012ea57a8f2191be6149f632250f7036119cc'; 

        let isLoggedIn = false;
        let appPassword = '';
        let inventory = [];
        let currentEditItem = null;
        let currentAction = '';
        let githubToken = '';
        let githubUsername = '';
        let githubRepo = '';
        let githubFileSha = '';
        const GITHUB_FILE_PATH = 'medicine-inventory.json';
        let draggedElement = null;
        let draggedIndex = null;

        // åˆ†é¡åœ–ç¤ºå°ç…§è¡¨
        const categoryIcons = {
            'è—¥å“': 'ğŸ’Š',
            'ä¿å¥å“': 'ğŸ¥—',
            'å¤–ç”¨è—¥': 'ğŸ§´',
            'é†«ç™‚ç”¨å“': 'ğŸ©¹',
            'å…¶ä»–': 'ğŸ“¦'
        };

        // ============ ç™»å…¥èˆ‡åˆå§‹åŒ– ============
        function login() {
            const password = document.getElementById('appPassword').value;
            const hash = CryptoJS.SHA256(password).toString();
            
            if (hash === APP_PASSWORD_HASH) {
                isLoggedIn = true;
                appPassword = password;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadSettings();
                init();
            } else {
                const err = document.getElementById('loginError');
                err.textContent = 'Invalid';
                err.classList.remove('hidden');
                setTimeout(() => err.classList.add('hidden'), 2000);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('appPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });

        function encryptData(data) { return CryptoJS.AES.encrypt(JSON.stringify(data), appPassword).toString(); }
        
        function decryptData(encryptedData) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, appPassword);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch (error) { console.error('è§£å¯†å¤±æ•—', error); return null; }
        }

        function init() {
            if (githubToken && githubUsername) {
                updateSyncStatus('connected', 'âœ… å·²é€£æ¥ GitHub');
                loadFromGitHub();
            } else {
                updateSyncStatus('offline', 'âš ï¸ è«‹è¨­å®š GitHub');
            }
            const backup = localStorage.getItem('inventoryBackup');
            if (backup && !githubToken) {
                inventory = JSON.parse(backup);
                renderInventory();
                updateStats();
            }
        }

        // ... (GitHub ç›¸é—œåŠŸèƒ½ä»£ç¢¼ä¿æŒä¸è®Šï¼Œçœç•¥ä»¥ç¯€çœç¯‡å¹…) ...
        // è«‹ç›´æ¥è¤‡è£½ä¹‹å‰ç‰ˆæœ¬çš„ GitHub åŠŸèƒ½å‡½æ•¸ï¼š
        // loadSettings, toggleAuthPanel, saveGitHubConfig, testGitHubConnection, 
        // disconnectGitHub, loadFromGitHub, saveToGitHub, manualSync, updateSyncStatus
        
        function loadSettings() {
            githubToken = localStorage.getItem('githubToken_secure') || '';
            githubUsername = localStorage.getItem('githubUsername_secure') || '';
            githubRepo = localStorage.getItem('githubRepo_secure') || 'medicine-data';
            
            if (githubToken) {
                document.getElementById('githubToken').value = githubToken;
                document.getElementById('githubUsername').value = githubUsername;
                document.getElementById('githubRepo').value = githubRepo;
                document.getElementById('disconnectBtn').style.display = 'inline-block';
            }
        }

        function toggleAuthPanel() { document.getElementById('authContent').classList.toggle('active'); }
        function toggleAddItemPanel() { document.getElementById('addItemContent').classList.toggle('active'); }

        async function saveGitHubConfig() {
            // ... åŒå‰ç‰ˆ ...
            const token = document.getElementById('githubToken').value.trim();
            const username = document.getElementById('githubUsername').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            if (!token || !username || !repo) { alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼'); return; }
            githubToken = token; githubUsername = username; githubRepo = repo;
            localStorage.setItem('githubToken_secure', token);
            localStorage.setItem('githubUsername_secure', username);
            localStorage.setItem('githubRepo_secure', repo);
            document.getElementById('disconnectBtn').style.display = 'inline-block';
            testGitHubConnection();
        }
        
        async function testGitHubConnection() {
            // ... åŒå‰ç‰ˆ ...
             if (!githubToken) return;
            updateSyncStatus('syncing', 'ğŸ” é€£ç·šæ¸¬è©¦...');
            try {
                const r = await fetch(`https://api.github.com/repos/${githubUsername}/${githubRepo}`, { headers: { 'Authorization': `token ${githubToken}` } });
                if (r.ok) { updateSyncStatus('connected', 'âœ… é€£ç·šæˆåŠŸ'); loadFromGitHub(); }
                else throw new Error(r.status);
            } catch (e) { updateSyncStatus('offline', 'âŒ é€£ç·šå¤±æ•—'); }
        }

        function disconnectGitHub() {
             if (confirm('æ–·é–‹é€£æ¥ï¼Ÿ')) {
                localStorage.removeItem('githubToken_secure');
                githubToken = ''; 
                document.getElementById('disconnectBtn').style.display = 'none';
                updateSyncStatus('offline', 'âŒ å·²æ–·é–‹');
            }
        }

        async function loadFromGitHub() {
             // ... åŒå‰ç‰ˆ ...
             if (!githubToken) return;
             try {
                 const r = await fetch(`https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${GITHUB_FILE_PATH}`, 
                 { headers: { 'Authorization': `token ${githubToken}` } });
                 if(r.ok) {
                     const d = await r.json();
                     githubFileSha = d.sha;
                     const c = decryptData(atob(d.content));
                     if(c) { inventory = c; renderInventory(); updateStats(); updateSyncStatus('connected', 'âœ… å·²è¼‰å…¥'); }
                 } else if (r.status === 404) { await saveToGitHub(); }
             } catch(e) { updateSyncStatus('offline', 'âŒ è¼‰å…¥å¤±æ•—'); }
        }

        async function saveToGitHub() {
             // ... åŒå‰ç‰ˆ ...
             if(!githubToken) return false;
             try {
                 const content = btoa(unescape(encodeURIComponent(encryptData(inventory))));
                 const body = { message: 'update', content: content, sha: githubFileSha || undefined };
                 const r = await fetch(`https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${GITHUB_FILE_PATH}`,
                 { method: 'PUT', headers: {'Authorization':`token ${githubToken}`}, body: JSON.stringify(body)});
                 if(r.ok) { const d = await r.json(); githubFileSha = d.content.sha; updateSyncStatus('connected', 'âœ… å·²åŒæ­¥'); return true; }
             } catch(e) { return false; }
        }

        async function manualSync() { if(await saveToGitHub()) alert('âœ… åŒæ­¥å®Œæˆ'); }
        
        function updateSyncStatus(s, m) { 
            document.getElementById('statusText').textContent = m;
            const ind = document.getElementById('statusIndicator');
            ind.className = s === 'connected' || s === 'syncing' ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
        }

        function saveData() {
            localStorage.setItem('inventoryBackup', JSON.stringify(inventory));
            if (githubToken) saveToGitHub();
        }

        // ============ æ–°å¢/ç·¨è¼¯åŠŸèƒ½ ============
        function toggleQuantityInput() {
            const type = document.getElementById('itemType').value;
            const qtyGroup = document.getElementById('quantityGroup');
            const minStockGroup = document.getElementById('minStockGroup');
            
            if (type === 'log_only') {
                qtyGroup.style.display = 'none';
                minStockGroup.style.display = 'none';
            } else {
                qtyGroup.style.display = 'block';
                minStockGroup.style.display = 'block';
            }
        }

        function addItem() {
            const name = document.getElementById('itemName').value.trim();
            if (!name) { alert('è«‹è¼¸å…¥åç¨±'); return; }

            const type = document.getElementById('itemType').value;
            const isLogOnly = type === 'log_only';

            const item = {
                id: Date.now(),
                name: name,
                category: document.getElementById('itemCategory').value,
                type: type, // countable æˆ– log_only
                quantity: isLogOnly ? 1 : (parseInt(document.getElementById('itemQuantity').value) || 0), // log_only é è¨­æœ‰è²¨(1)
                expiry: document.getElementById('itemExpiry').value,
                minStock: isLogOnly ? 0 : (parseInt(document.getElementById('itemMinStock').value) || 0),
                note: document.getElementById('itemNote').value.trim(),
                isArchived: false,
                history: [{ date: new Date().toISOString(), action: 'æ–°å¢', quantity: isLogOnly ? '-' : 0, note: 'åˆå§‹å»ºç«‹' }]
            };

            inventory.push(item);
            saveData();
            renderInventory();
            updateStats();
            
            // æ¸…ç©º
            document.getElementById('itemName').value = '';
            document.getElementById('itemQuantity').value = '0';
            document.getElementById('itemExpiry').value = '';
            document.getElementById('itemNote').value = '';
            alert('âœ… æ–°å¢æˆåŠŸ');
        }

        // ============ åˆ—è¡¨æ¸²æŸ“ ============
        function renderInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const showArchived = document.getElementById('showArchived').checked;

            const filtered = inventory.filter(item => {
                const matchSearch = item.name.toLowerCase().includes(searchTerm) || item.category.toLowerCase().includes(searchTerm);
                if (showArchived) return matchSearch;
                return matchSearch && !item.isArchived && item.quantity > 0; // log_only ç”¨å®Œ(0)ä¹Ÿä¸é¡¯ç¤º
            });

            filtered.forEach((item) => {
                const row = document.createElement('tr');
                if (item.isArchived) row.classList.add('archived-row');
                
                // è™•ç†èˆŠè³‡æ–™å…¼å®¹æ€§ (é è¨­ç‚º countable)
                const itemType = item.type || 'countable';
                const isLogOnly = itemType === 'log_only';

                // æ‹–æ›³
                row.draggable = true;
                row.dataset.index = inventory.indexOf(item);
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
                row.addEventListener('dragend', handleDragEnd);

                // ç‹€æ…‹é¡¯ç¤º
                let quantityDisplay = '';
                if (isLogOnly) {
                    quantityDisplay = `<span class="status-badge">ä½¿ç”¨ä¸­</span>`;
                } else {
                    quantityDisplay = `<strong>${item.quantity}</strong>`;
                    if (!item.isArchived) {
                        if (item.quantity === 0) row.classList.add('stock-zero');
                        else if (item.minStock > 0 && item.quantity <= item.minStock) row.classList.add('stock-low');
                    }
                }

                // æœ€å¾Œä½¿ç”¨æ™‚é–“ (æ ¼å¼åŒ–: YYYY/MM/DD HH:MM)
                let lastUsedStr = '-';
                if (item.history) {
                    const lastUse = item.history
                        .filter(h => ['ä½¿ç”¨','æ¸›å°‘','ç´€éŒ„'].includes(h.action))
                        .sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                    if (lastUse) {
                        const d = new Date(lastUse.date);
                        // è£œé›¶å‡½æ•¸
                        const pad = (n) => n < 10 ? '0'+n : n;
                        lastUsedStr = `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} <br> ${pad(d.getHours())}:${pad(d.getMinutes())}`;
                    }
                }

                // æ“ä½œæŒ‰éˆ•
                let actionButtons = '';
                if (!item.isArchived) {
                    actionButtons += `<button class="btn-secondary" onclick="openEditModal(${item.id})">âœï¸</button> `;
                    if (isLogOnly) {
                        actionButtons += `
                            <button class="btn-log" onclick="openLogModal(${item.id})">â±ï¸</button>
                            <button class="btn-finish" onclick="markAsFinished(${item.id})">ğŸ</button>
                        `;
                    } else {
                        actionButtons += `
                            <button class="btn-success" onclick="openQuantityModal(${item.id}, 'add')">â•</button>
                            <button class="btn-warning" onclick="openQuantityModal(${item.id}, 'reduce')">â–</button>
                        `;
                    }
                }
                
                // å°å­˜æŒ‰éˆ•
                const archiveBtn = item.isArchived 
                    ? `<button class="btn-unarchive" onclick="toggleArchive(${item.id})">ğŸ”“</button>`
                    : `<button class="btn-archive" onclick="toggleArchive(${item.id})">ğŸ“¦</button>`;
                
                actionButtons += `<button class="btn-info" onclick="showHistory(${item.id})">ğŸ“‹</button> ${archiveBtn} <button class="btn-danger" onclick="deleteItem(${item.id})">ğŸ—‘ï¸</button>`;

                // åˆ†é¡åœ–ç¤ºèˆ‡ Tooltip
                const icon = categoryIcons[item.category] || 'ğŸ“¦';
                
                row.innerHTML = `
                    <td><span class="drag-handle">â‹®â‹®</span></td>
                    <td title="${item.category}"><span class="category-icon">${icon}</span></td>
                    <td><strong>${item.name}</strong>${item.isArchived ? ' (å·²å°å­˜)' : ''}</td>
                    <td>${quantityDisplay}</td>
                    <td>${item.expiry || '-'}</td>
                    <td style="font-size: 13px; color: #555;">${lastUsedStr}</td>
                    <td>${item.note || '-'}</td>
                    <td><div class="action-buttons">${actionButtons}</div></td>
                `;
                tbody.appendChild(row);
            });
            
            if (filtered.length === 0) tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">ç„¡è³‡æ–™</td></tr>';
        }

        // ============ ç´€éŒ„å‹åŠŸèƒ½ ============
        function openLogModal(id) {
            currentEditItem = inventory.find(i => i.id === id);
            document.getElementById('logItemName').textContent = currentEditItem.name;
            document.getElementById('logNote').value = '';
            document.getElementById('logModal').style.display = 'block';
        }

        function confirmLogUse() {
            const note = document.getElementById('logNote').value.trim();
            currentEditItem.history.push({
                date: new Date().toISOString(),
                action: 'ç´€éŒ„',
                quantity: '-',
                note: note ? `ä½¿ç”¨ç´€éŒ„ (${note})` : 'ä½¿ç”¨ç´€éŒ„'
            });
            saveData();
            renderInventory();
            document.getElementById('logModal').style.display = 'none';
        }

        function closeLogModal() { document.getElementById('logModal').style.display = 'none'; }

        function markAsFinished(id) {
            if (confirm('ç¢ºå®šæ¨™è¨˜ç‚ºå·²ç”¨å®Œå—ï¼Ÿ\nè©²å“é …å°‡ä¸å†é¡¯ç¤ºæ–¼åˆ—è¡¨ä¸­ (é™¤éå‹¾é¸é¡¯ç¤ºå·²å°å­˜/ç”¨å®Œ)')) {
                const item = inventory.find(i => i.id === id);
                item.quantity = 0; // è¨­ç‚º 0 ä»£è¡¨ç”¨å®Œ
                item.history.push({
                    date: new Date().toISOString(),
                    action: 'ç”¨å®Œ',
                    quantity: 0,
                    note: 'æ¨™è¨˜å·²ç”¨å®Œ'
                });
                saveData();
                renderInventory();
            }
        }

        // ============ ç·¨è¼¯åŠŸèƒ½ (å«é¡å‹åˆ‡æ›) ============
        function toggleEditQuantityInput() {
            const type = document.getElementById('editType').value;
            const qty = document.getElementById('editQuantityGroup');
            const min = document.getElementById('editMinStockGroup');
            if (type === 'log_only') {
                qty.style.display = 'none';
                min.style.display = 'none';
            } else {
                qty.style.display = 'block';
                min.style.display = 'block';
            }
        }

        function openEditModal(id) {
            currentEditItem = inventory.find(i => i.id === id);
            // è™•ç†èˆŠè³‡æ–™
            const type = currentEditItem.type || 'countable'; 
            
            document.getElementById('editName').value = currentEditItem.name;
            document.getElementById('editType').value = type;
            document.getElementById('editCategory').value = currentEditItem.category;
            document.getElementById('editQuantity').value = currentEditItem.quantity;
            document.getElementById('editExpiry').value = currentEditItem.expiry || '';
            document.getElementById('editMinStock').value = currentEditItem.minStock || 0;
            document.getElementById('editNote').value = currentEditItem.note || '';
            
            toggleEditQuantityInput(); // æ ¹æ“šé¡å‹åˆå§‹åŒ–é¡¯ç¤º
            document.getElementById('editModal').style.display = 'block';
        }

        function confirmEdit() {
            const newType = document.getElementById('editType').value;
            // è‹¥å¾ countable åˆ‡æ›åˆ° log_onlyï¼Œå¼·åˆ¶è¨­æ•¸é‡ç‚º 1 (ä»£è¡¨ä½¿ç”¨ä¸­)
            if (newType === 'log_only') {
                currentEditItem.quantity = 1;
                currentEditItem.minStock = 0;
            } else {
                currentEditItem.quantity = parseInt(document.getElementById('editQuantity').value) || 0;
                currentEditItem.minStock = parseInt(document.getElementById('editMinStock').value) || 0;
            }

            currentEditItem.type = newType;
            currentEditItem.name = document.getElementById('editName').value;
            currentEditItem.category = document.getElementById('editCategory').value;
            currentEditItem.expiry = document.getElementById('editExpiry').value;
            currentEditItem.note = document.getElementById('editNote').value;

            currentEditItem.history.push({ date: new Date().toISOString(), action: 'ç·¨è¼¯', note: 'è³‡æ–™æ›´æ–°' });
            
            saveData();
            renderInventory();
            closeEditModal();
        }

        // ============ å…¶ä»–åŸæœ‰åŠŸèƒ½ (æ‹–æ›³ã€çµ±è¨ˆã€å°å­˜ç­‰) ============
        // ä¿æŒèˆ‡å‰ç‰ˆä¸€è‡´
        function handleDragStart(e) { draggedElement = this; draggedIndex = parseInt(this.dataset.index); this.classList.add('dragging'); }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
        function handleDrop(e) {
            e.stopPropagation();
            const dropIndex = parseInt(this.dataset.index); // é€™è£¡éœ€è¦æ³¨æ„ï¼Œindex å¿…é ˆæ˜¯å…¨åŸŸçš„ index
            // ç”±æ–¼ç›®å‰ renderInventory è£¡ dataset.index æ˜¯åœ¨ filter å¾Œçš„ index
            // ç°¡å–®è§£æ³•ï¼šæ‹–æ›³åŠŸèƒ½åƒ…åœ¨é¡¯ç¤ºå…¨éƒ¨æ™‚æº–ç¢ºï¼Œæˆ–æ˜¯éœ€è¦é‡æ§‹ index æŸ¥æ‰¾é‚è¼¯
            // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘ç”¨ inventory.indexOf(item) ç¢ºä¿æ˜¯å°åŸå§‹é™£åˆ—æ“ä½œ
            // ä¸Šé¢ renderInventory å·²ç¶“æ”¹ç”¨ indexOf
             if (draggedIndex !== dropIndex && draggedIndex !== null) {
                const item = inventory[draggedIndex];
                inventory.splice(draggedIndex, 1);
                inventory.splice(dropIndex, 0, item);
                saveData();
                renderInventory();
            }
        }
        function handleDragEnd() { this.classList.remove('dragging'); draggedElement = null; draggedIndex = null; }

        function toggleArchive(id) {
            const item = inventory.find(i => i.id === id);
            item.isArchived = !item.isArchived;
            saveData(); renderInventory(); updateStats();
        }

        function deleteItem(id) {
            if(confirm('åˆªé™¤?')) { inventory = inventory.filter(i => i.id !== id); saveData(); renderInventory(); updateStats(); }
        }

        function updateStats() {
            const active = inventory.filter(i => !i.isArchived && i.quantity > 0);
            const total = active.length;
            const expired = active.filter(i => i.expiry && new Date(i.expiry) < new Date()).length;
            document.getElementById('stats').innerHTML = `
                <div class="stat-card"><h3>${total}</h3><p>ä½¿ç”¨ä¸­</p></div>
                <div class="stat-card"><h3>${expired}</h3><p>å·²éæœŸ</p></div>
            `;
        }

        function openQuantityModal(id, action) {
             // ... åŒå‰ç‰ˆ ...
            currentEditItem = inventory.find(i => i.id === id);
            currentAction = action;
            document.getElementById('modalTitle').textContent = action === 'add' ? `â• å¢åŠ : ${currentEditItem.name}` : `â– æ¸›å°‘: ${currentEditItem.name}`;
            document.getElementById('modalQuantity').value = '1';
            document.getElementById('modalNote').value = '';
            document.getElementById('quantityModal').style.display = 'block';
        }

        function confirmQuantityChange() {
             // ... åŒå‰ç‰ˆ ...
             const qty = parseInt(document.getElementById('modalQuantity').value);
            const note = document.getElementById('modalNote').value.trim();
            if (qty <= 0) return;
            if (currentAction === 'add') {
                currentEditItem.quantity += qty;
                currentEditItem.history.push({ date: new Date().toISOString(), action: 'è³¼è²·', quantity: qty, note: note });
            } else {
                if (currentEditItem.quantity < qty) { alert('åº«å­˜ä¸è¶³'); return; }
                currentEditItem.quantity -= qty;
                currentEditItem.history.push({ date: new Date().toISOString(), action: 'ä½¿ç”¨', quantity: qty, note: note });
            }
            saveData(); renderInventory(); updateStats(); closeModal();
        }

        function showHistory(id) {
             // ... åŒå‰ç‰ˆï¼Œå¢åŠ é¡¯ç¤ºæ™‚é–“ ...
             const item = inventory.find(i => i.id === id);
            const content = document.getElementById('historyContent');
            content.innerHTML = `<h3>${item.name} æ­·å²ç´€éŒ„</h3>`;
            item.history.slice().reverse().forEach(h => {
                content.innerHTML += `<div class="history-item"><strong>${h.action}</strong> - ${new Date(h.date).toLocaleString()}<br>${h.note || ''}</div>`;
            });
            document.getElementById('historyModal').style.display = 'block';
        }

        function filterItems() { renderInventory(); }
        function exportBackup() { /* ... åŒå‰ç‰ˆ ... */ }
        function closeModal() { document.getElementById('quantityModal').style.display = 'none'; }
        function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }
        function closeHistoryModal() { document.getElementById('historyModal').style.display = 'none'; }

        window.onclick = function(e) { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; }
    </script>
</body>
</html>
